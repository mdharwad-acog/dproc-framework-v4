services:
  # =============================================================================
  # REDIS - Job Queue
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: dproc-redis
    labels:
      - "exclude=true"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "6379:6379" # Exposed for host network worker
    networks:
      - dproc-network

  # =============================================================================
  # DPROC WEB - Next.js Web UI
  # =============================================================================
  dproc-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dproc-web
    labels:
      - "user=${USER:-mdharwad}"
      - "description=DProc Framework - LLM Report Generation Web UI"
    volumes:
      # Shared workspace for pipelines and outputs
      - /shared/dproc-workspace:/shared/dproc-workspace

      # Secrets file (API keys) - read-only
      - ${HOME}/.dproc:/root/.dproc:ro

      # Persistent database storage
      - dproc-data:/app/data
    environment:
      # ========================================================================
      # DATA STORAGE - JSON File Storage
      # ========================================================================
      DATA_DIR: /app/data

      # ========================================================================
      # WORKSPACE
      # ========================================================================
      DPROC_WORKSPACE: /shared/dproc-workspace

      # ========================================================================
      # REDIS CONFIGURATION
      # ========================================================================
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # ========================================================================
      # NODE CONFIGURATION
      # ========================================================================
      NODE_ENV: production

      # ========================================================================
      # API KEYS (Optional - can use ~/.dproc/secrets.json instead)
      # Uncomment and set these if you want to use environment variables
      # ========================================================================
      # OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # ========================================================================
      # DEBUG (Optional)
      # ========================================================================
      # DEBUG: ${DEBUG:-}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/stats', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    ports:
      - "3000:3000"
    networks:
      - dproc-network

  # =============================================================================
  # DPROC WORKER - Background Job Processor
  # Uses host network to bypass Crostini container networking restrictions
  # =============================================================================
  dproc-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dproc-worker
    labels:
      - "exclude=true"
    # Override default command to run worker
    command: ["node", "/app/packages/dproc-core/bin/dproc-worker.js"]
    volumes:
      # Shared workspace for pipelines and outputs
      - /shared/dproc-workspace:/shared/dproc-workspace

      # Secrets file (API keys) - read-only
      - ${HOME}/.dproc:/root/.dproc

      # Share same database with web UI
      - dproc-data:/app/data
    environment:
      # ========================================================================
      # DATA STORAGE - JSON File Storage (shared with web)
      # ========================================================================
      DATA_DIR: /app/data

      # ========================================================================
      # WORKSPACE
      # ========================================================================
      DPROC_WORKSPACE: /shared/dproc-workspace

      # ========================================================================
      # REDIS CONFIGURATION - localhost since using host network
      # ========================================================================
      REDIS_HOST: localhost
      REDIS_PORT: 6379

      # ========================================================================
      # WORKER SETTINGS
      # ========================================================================
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-2}

      # ========================================================================
      # NODE CONFIGURATION
      # ========================================================================
      NODE_ENV: production

      # ========================================================================
      # API KEYS (Optional - can use ~/.dproc/secrets.json instead)
      # Priority: ENV vars > secrets.json
      # ========================================================================
      # OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      # GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # ========================================================================
      # DEBUG (Optional)
      # ========================================================================
      DEBUG: ${DEBUG:-dproc:*}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

    # ========================================================================
    # HOST NETWORK MODE
    # Bypasses Chrome OS Crostini networking restrictions for direct internet
    # access. Worker connects to Redis via localhost:6379
    # ========================================================================
    network_mode: "host"

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # Redis persistent storage
  redis-data:
    driver: local

  # Shared JSON database storage (executions, stats)
  dproc-data:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  dproc-network:
    driver: bridge
